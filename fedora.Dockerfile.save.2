# syntax=docker/dockerfile:1

# Blender Builder - ARM64 Optimized with Cache Mounts
# Use an official Fedora image as the base.
# The --platform flag ensures the correct architecture is pulled.
# MaterialX with cache mount

FROM fedora:42

# Set frontend to noninteractive equivalent and TERM
#ENV TERM=xterm
# Note: Fedora doesn't use DEBIAN_FRONTEND, dnf handles non-interactive mode differently

# Install essential build tools and dependencies with cache mounts
# This single RUN command consolidates all system dependencies to optimize layer caching.
RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf update -y && \
    # Core build tools (equivalent to build-essential)
    dnf install -y dnf-plugins-core @c-development @development-tools\
    \
    # --- Core Development & Build Tools ---
    git git-lfs ninja-build meson pkgconf subversion \
    autoconf automake bison libtool yasm patchelf wget tar \
    cmake gcc-c++ patch rpm-build \
    \
    # --- System & Math Libraries ---
    glibc glibc-devel libstdc++-devel kernel-devel \
    gmp-devel libfftw3-devel fftw-devel tbb-devel tbb\
    \
    # --- Python Ecosystem ---
    python3-devel python3-libs python3-pybind11 python3-numpy \
    python3-requests python3-certifi python3-idna python3-urllib3 \
    python3-charset-normalizer python3-zstandard python3-cattrs \
    python3-cython python3-fastjsonschema \
    \
    # --- VFX & Rendering Core Libraries ---
    alembic-devel usd usd-devel openvdb-devel opensubdiv-devel \
    openshadinglanguage-devel \
    OpenImageIO-utils openexr-devel imath-devel oidn-devel \
    embree-devel openpgl-devel oneapi-level-zero-devel \
    opencollada-devel potrace-devel harfbuzz-devel \
    \
    # --- Graphics, Windowing & Display (X11/Wayland) ---
    wayland-devel wayland-protocols-devel libdecor-devel \
    libX11-devel libXt-devel libXcursor-devel libXi-devel \
    libXrandr-devel libxkbcommon-devel libXxf86vm-devel \
    libXfixes-devel libXrender-devel libXinerama-devel \
    fontconfig-devel dbus-devel xorg-x11-server-Xorg xorg-x11-xauth \
    \
    # --- GPU & Shading APIs (OpenGL/Vulkan) ---
    mesa-libGL-devel mesa-libEGL-devel egl-wayland-devel \
    mesa-dri-drivers mesa-libGLES-devel libepoxy-devel \
    glew-devel glfw-devel openxr-devel \
    vulkan-headers vulkan-loader-devel vulkan-devel \
    libshaderc-devel shaderc \
    \
    # --- Image I/O & Formats ---
    libjpeg-turbo-devel libpng-devel libtiff-devel \
    openjpeg2-devel libwebp-devel libharu-devel \
    \
    # --- Audio & Multimedia ---
    ffmpeg-free-devel libswresample-free-devel libavdevice-free-devel \
    libavformat-free-devel libavfilter-free-devel libswscale-free-devel \
    openal-soft-devel SDL2-devel libsndfile-devel \
    jack-audio-connection-kit-devel gstreamer1-devel gstreamer1-plugins-base-devel \
    pulseaudio-libs-devel pipewire-devel \
    \
    # --- Utility & Helper Libraries ---
    boost-devel pugixml-devel yaml-cpp-devel pystring-devel \
    zlib-devel libzstd-devel openssl-devel openssl brotli-devel \
    libdeflate-devel libjemalloc-devel blosc-devel \
    clang-devel llvm-devel clang clang-tools-extra libclang-devel \
    ispc ispc-devel systemd-devel libusb-devel \
    \
    # --- Miscellaneous Libraries ---
    libspnav-devel libavahi-devel libcanberra-devel \
    webrtc-audio-processing-devel lilv-devel libebur128-devel \
    libmysofa-devel libcap-devel hydra valgrind libuhd-devel \
    \
    # Clean up dnf cache to reduce image size
    && dnf clean all

# Set PYTHONPATH to custom site-packages directory (adjusted for Fedora paths)
ENV PYTHONPATH="/usr/local/lib/python3.11/site-packages:${PYTHONPATH}"

# Install remaining Python packages via pip with cache mount
# Only packages not available in Fedora repositories are installed here.
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --upgrade pip && \
    pip install numpy charset-normalizer urllib3 zstandard requests idna certifi alembic mako jinja2

# ----------------------------------------------------------------------
# 1 Sse2Neon
# Install SSE2NEON headers with cache mount
RUN echo "Installing SSE2NEON headers" && \
    git clone --depth=1 https://github.com/DLTcollab/sse2neon.git /tmp/sse2neon && \
    mkdir -p /usr/local/include/sse2neon && \
    cp /tmp/sse2neon/sse2neon.h /usr/local/include/sse2neon/ && \
    rm -rf /tmp/sse2neon && \
    echo "SSE2NEON headers installed"

# ----------------------------------------------------------------------
# 2. Build and Install libnanovdb-devel from source
# This library is not available in the standard Fedora repositories.
RUN echo "Building libnanovdb-devel from source" && \
    git clone --recursive https://github.com/AcademySoftwareFoundation/nanovdb.git /tmp/nanovdb && \
    cd /tmp/nanovdb && \
    mkdir build && cd build && \
    cmake.. && \
    make -j$(nproc) install && \
    rm -rf /tmp/nanovdb && \
    echo "Done installing libnanovdb-devel"

# ----------------------------------------------------------------------
# 3. Build OpenImageIO from source
# Building a specific version from source for compatibility.
RUN echo "Building OpenImageIO v3.0.6.1" && \
    git clone --branch v3.0.6.1 --depth=1 \
      https://github.com/AcademySoftwareFoundation/OpenImageIO /tmp/build_linux/oiio && \
    cd /tmp/build_linux/oiio && mkdir -p build && cd build && \
    # Configure the build. System-provided dependencies will be found automatically.
    cmake.. -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_INSTALL_PREFIX=/usr/local \
      -DBUILD_SHARED_LIBS=ON \
      -DBUILD_DOCS=OFF \
      -DUSE_OPENVDB=OFF \
      -DUSE_FREETYPE=OFF \
      -DUSE_DCMTK=OFF \
      -DUSE_LIBHEIF=OFF \
      -DOIIO_BUILD_TESTS=OFF \
      -DBUILD_TESTING=OFF \
      -DSTOP_ON_WARNING=OFF \
      -DUSE_QT=OFF \
      -DUSE_GIF=OFF \
      -DUSE_OPENCV=OFF \
      -DUSE_FFMPEG=OFF \
      -DUSE_PTEX=OFF \
      -DUSE_LIBRAW=OFF \
      -DUSE_JXL=OFF \
      -DUSE_OPENCOLORIO=ON \
      -DUSE_WEBP=ON \
      -DUSE_TBB=ON \
      -DUSE_PYTHON=ON \
      -DUSE_OPENJPEG=ON && \
    cmake --build. && \
    cmake --install. && \
    echo "Done Installing OpenImageIO."

# ----------------------------------------------------------------------
# 4. Build MaterialX from source
RUN echo "Cloning MaterialX" && \
    git clone https://github.com/AcademySoftwareFoundation/MaterialX.git -b v1.39.4 --depth=1 /tmp/build_linux/materialx && \
    mkdir -p /tmp/build_linux/materialx/build && cd /tmp/build_linux/materialx/build && \
    cmake.. -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DMATERIALX_BUILD_GRAPH_EDITOR=OFF \
          -DMATERIALX_BUILD_PYTHON=ON \
          -DMATERIALX_BUILD_TESTS=OFF \
          -DMATERIALX_BUILD_VIEWER=OFF \
          -DCMAKE_CXX_FLAGS="-Wno-error=stringop-overflow" \
    && cmake --build. && \
    cmake --install. && \
    echo "Done Installing MaterialX"



# In case depot_tools expects pip-installed deps, ensure itâ€™s covered:
#RUN pip install --no-cache-dir httplib2 httplib2[socks] PySocks six pyasn1 pyasn1-modules urllib3
# Create a non-root user for the build process for security
# and grant passwordless sudo privileges.
RUN useradd --create-home --shell /bin/bash builder && \
    adduser builder sudo && \
    echo 'builder ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers


# Switch to the non-root user
#USER builder
WORKDIR /blender-git

# Copy the compile script into the container and make it executable
COPY --chown=builder:builder compile.sh /compile.sh
RUN chmod +x /compile.sh

# Set the entrypoint to our compile script
ENTRYPOINT ["/compile.sh"]
